# 持仓表格和飞书同步完整指南

## 🎯 概述

你已经成功创建了持仓表格! 现在有两种方式管理你的股票投资:

1. **Excel 本地管理** - 已完成 ✅
2. **飞书云端管理** - 可选配置

---

## 📊 第一部分: Excel 持仓表格使用

### 你的表格文件

✅ **已创建**: `/Users/solaeter/Documents/ldyoung/投资理财/美股管理Agent/stock-master/my_portfolio.xlsx`

### 表格结构

表格包含 4 个工作表:

#### 1. 持仓 (主表)
记录你当前持有的股票

**需要你手动填写的列**:
- `股票代码`: 如 `AAPL`, `TSLA`, `0700.HK`, `600519.SS`
- `股票名称`: 公司名称(可选)
- `持仓数量`: 当前持有的股数
- `买入均价`: 你的平均成本价
- `买入日期`: 建仓或最近加仓日期
- `备注`: 任何备注信息

**自动更新的列**(Claude 帮你填):
- `当前价格`: 从 Yahoo Finance 获取
- `市值`: 持仓数量 × 当前价格
- `盈亏金额`: 市值 - (持仓数量 × 买入均价)
- `盈亏比例`: 盈亏金额 / 成本 × 100%

#### 2. 交易记录
记录每次买入卖出操作(可选)

#### 3. 账户汇总
自动计算总投入、总市值、总盈亏

#### 4. 使用说明
详细的使用指南

### 如何使用

#### 方式一: 用 Claude 分析(推荐)

直接对话:
```
分析我的持仓
更新我的持仓价格
```

Claude 会:
1. 读取你的 Excel 表格
2. 获取实时股价
3. 更新盈亏数据
4. 给出投资建议

#### 方式二: 手动运行 Python 脚本

```bash
cd /Users/solaeter/Documents/ldyoung/投资理财/美股管理Agent/stock-master

# 更新持仓价格
python3 -c "
import sys
sys.path.insert(0, 'scripts')
from portfolio import read_portfolio, update_portfolio_prices
import yfinance as yf

# 读取持仓
data = read_portfolio('my_portfolio.xlsx')

# 获取当前价格
prices = {}
for h in data['holdings']:
    ticker = h['ticker']
    stock = yf.Ticker(ticker)
    prices[ticker] = stock.fast_info.last_price

# 更新表格
update_portfolio_prices('my_portfolio.xlsx', prices)
print('持仓价格已更新!')
"
```

### 示例:添加持仓

打开 `my_portfolio.xlsx`,在"持仓"表中添加:

| 股票代码 | 股票名称 | 持仓数量 | 买入均价 | 买入日期 | 备注 |
|---------|---------|---------|---------|---------|------|
| TSLA | 特斯拉 | 10 | 380.00 | 2024-01-15 | 长期持有 |
| AAPL | 苹果 | 20 | 175.00 | 2024-03-10 | |

然后对 Claude 说:"更新我的持仓价格"

---

## ☁️ 第二部分: 飞书同步配置(可选)

### 为什么要用飞书?

✅ **云端存储** - 数据不怕丢失  
✅ **多端访问** - 手机、电脑随时查看  
✅ **实时同步** - 分析结果自动上传  
✅ **协作功能** - 可以分享给家人朋友

### 配置步骤

#### 步骤 1: 创建飞书应用

1. 访问 [飞书开放平台](https://open.feishu.cn/)
2. 登录你的飞书账号
3. 点击"创建应用" → "企业自建应用"
4. 填写应用信息:
   - 应用名称: "股票管理助手"
   - 应用描述: "股票持仓和技术分析"
   - 上传图标(可选)

#### 步骤 2: 获取应用凭证

在应用管理页面:
1. 找到"应用凭证"
2. 复制 `App ID` (格式: cli_xxxxxx)
3. 复制 `App Secret`

#### 步骤 3: 配置权限

在"权限管理"中添加:
- `bitable:app` - 多维表格应用操作权限
- `bitable:app:readonly` - 多维表格应用只读权限

保存后,点击"创建版本"并发布应用。

#### 步骤 4: 创建多维表格

1. 在飞书中新建"多维表格"
2. 命名为"股票投资管理"
3. 复制表格 URL,提取信息:

**URL 格式**:
```
https://xxx.feishu.cn/base/APP_TOKEN?table=TABLE_ID
```

- `APP_TOKEN`: base/ 和 ? 之间的部分
- `TABLE_ID`: table= 后面的部分(格式: tblXXXX)

#### 步骤 5: 创建飞书配置文件

在项目目录创建 `feishu_config.json`:

```bash
cd /Users/solaeter/Documents/ldyoung/投资理财/美股管理Agent/stock-master
```

创建文件内容:
```json
{
  "APP_ID": "cli_xxxxxxxxx",
  "APP_SECRET": "你的App Secret",
  "APP_TOKEN": "你的多维表格Token",
  "TABLE_ID": "tblXXXXXXXXXX"
}
```

> ⚠️ **安全提示**: 不要把配置文件提交到 Git,已在 `.gitignore` 中排除

#### 步骤 6: 初始化飞书表结构

运行初始化脚本:
```bash
python3 scripts/feishu_init_tables.py
```

或对 Claude 说:"初始化飞书表格"

这会自动创建3个表:
1. **技术信号表** - 存储股票分析结果
2. **持仓管理表** - 存储持仓数据
3. **交易记录表** - 存储交易历史

#### 步骤 7: 测试连接

```bash
cd scripts
python3 -c "from feishu_sync import test_connection; import json; print(json.dumps(test_connection(), ensure_ascii=False, indent=2))"
```

如果看到 `"status": "ok"`,说明配置成功!

### 如何同步数据

#### 同步股票分析结果

对 Claude 说:
```
分析 TSLA 并同步到飞书
```

#### 同步持仓数据

对 Claude 说:
```
同步我的持仓到飞书
```

#### 记录交易

对 Claude 说:
```
记录交易: 买入 AAPL 10股 @ $185
```

### Python 代码示例

```python
from scripts.feishu_sync import FeishuBitable, sync_stock_signal

# 初始化连接
bitable = FeishuBitable()

# 同步分析结果
signal_data = {
    'ticker': 'TSLA',
    'name': '特斯拉',
    'current_price': 385.5,
    'score': 5,
    'action': '建议买入',
    'rsi': 45.2,
    'macd_signal': '金叉',
    'kdj_signal': '超卖',
    'reasons': ['RSI 超卖', 'MACD 金叉', 'KDJ 金叉'],
    'stop_loss': 360.0,
    'take_profit': 420.0
}

result = sync_stock_signal(bitable, signal_data)
print("同步成功!")
```

---

## 🛠️ 常见问题

### Q1: Excel 表格在哪里?
**A**: `/Users/solaeter/Documents/ldyoung/投资理财/美股管理Agent/stock-master/my_portfolio.xlsx`

### Q2: 如何查看持仓?
**A**: 
- 直接打开 Excel 文件查看
- 或对 Claude 说:"分析我的持仓"

### Q3: Claude 如何更新价格?
**A**: 对 Claude 说:"更新我的持仓价格",它会:
1. 读取你的持仓数据
2. 从 Yahoo Finance 获取实时价格
3. 计算盈亏并更新 Excel

### Q4: 飞书同步是必须的吗?
**A**: 不是。飞书是可选功能。如果你只想本地管理,使用 Excel 就够了。

### Q5: 飞书配置太复杂,有简化方案吗?
**A**: 如果觉得麻烦,可以只用 Excel 本地管理。飞书主要优势是云端多端访问。

### Q6: 做T后如何更新持仓?
**A**: 只需更新最终结果:
- 持仓数量: 做T后实际持有的股数
- 买入均价: 做T后的实际均价(从券商 APP 查看)

### Q7: 如何添加港股或A股?
**A**: 
- 港股: `0700.HK`, `9988.HK`
- A股上海: `600519.SS`
- A股深圳: `000001.SZ`

### Q8: 提示"Too Many Requests"怎么办?
**A**: Yahoo Finance API 限流,等待 30分钟后重试。

---

## 💡 推荐使用方式

### 初学者推荐: 纯 Excel 本地管理

1. 打开 `my_portfolio.xlsx`
2. 填写你的持仓信息
3. 对 Claude 说:"分析我的持仓"
4. 定期说:"更新我的持仓价格"

### 进阶用户: Excel + 飞书双管齐下

1. 本地用 Excel 记录
2. 配置飞书同步
3. 分析时自动上传到云端
4. 手机随时查看飞书表格

---

## 📝 快速命令参考

### Excel 持仓管理
```
分析我的持仓
更新我的持仓价格
查看我的总盈亏
```

### 股票分析
```
分析 TSLA 股票
看看苹果能买吗
对比 NVDA 和 AMD
```

### 飞书同步(需先配置)
```
同步持仓到飞书
分析 AAPL 并同步到飞书
记录交易: 买入 TSLA 5股 @ $400
```

---

## ✅ 你已完成

- [x] 创建 Excel 持仓表格
- [x] 了解如何使用持仓表格
- [x] 了解飞书同步配置方法

## 🎯 下一步

**选择一:**
1. 打开 `my_portfolio.xlsx`
2. 添加你的实际持仓
3. 对 Claude 说:"分析我的持仓"

**选择二:**
1. 配置飞书应用和多维表格
2. 创建 `feishu_config.json`
3. 运行 `python3 scripts/feishu_init_tables.py`
4. 对 Claude 说:"测试飞书连接"

---

**需要帮助?** 直接问 Claude!
- "如何添加新持仓?"
- "飞书配置步骤不清楚"
- "如何计算我的投资收益率?"
